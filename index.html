<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Technical Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #e0e0e0;
            background-color: #1e1e1e;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #4fc3f7;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 10px;
            font-weight: 400;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
        }
        h2 {
            font-size: 2em;
            margin-top: 40px;
        }
        h3 {
            font-size: 1.5em;
            border-bottom: 1px solid #0288d1;
        }
        p, li {
            font-size: 1.1em;
            color: #cccccc;
        }
        code {
            background-color: #2d2d2d;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: "Fira Code", "Courier New", monospace;
            color: #ffcc80;
        }
        .card {
            background-color: #2a2a2a;
            border: 1px solid #383838;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .diagram-container {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: #252525;
            border-radius: 8px;
        }
        svg {
            width: 100%;
            max-width: 900px;
            height: auto;
        }
        .improvement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .improvement-card {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .improvement-card svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Project Technical Documentation</h1>

        <div class="card">
            <h2>1. Current System Architecture</h2>
            <p>The application is designed as a high-performance, multi-process system to fuse radar data with CAN bus signals in real time. The architecture prioritizes stability and performance by isolating hardware interactions and processing data in parallel pipelines.</p>
            
            <div class="diagram-container">
                <h3>Dual Pipeline Architecture Diagram</h3>
                <svg viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg">
                    <defs><marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#4fc3f7" /></marker></defs>
                    <rect x="10" y="10" width="780" height="480" fill="none" stroke="#555" stroke-width="2" rx="10"/>
                    <text x="400" y="35" font-family="sans-serif" font-size="16" fill="#ccc" text-anchor="middle">CAN Logger Process</text>

                    <rect x="30" y="215" width="120" height="50" fill="#333" rx="5"/><text x="90" y="245" font-family="sans-serif" font-size="14" fill="#ccc" text-anchor="middle">CAN Hardware</text>
                    <rect x="210" y="215" width="120" height="50" fill="#3c3c3c" rx="5"/><text x="270" y="237" font-family="sans-serif" font-size="14" fill="#ccc" text-anchor="middle">CANReader</text><text x="270" y="255" font-family="sans-serif" font-size="10" fill="#aaa" text-anchor="middle">(Single Thread)</text>
                    <line x1="150" y1="240" x2="210" y2="240" stroke="#4fc3f7" stroke-width="2" marker-end="url(#arrow)"/>

                    <!-- High Freq Pipeline -->
                    <text x="550" y="70" font-family="sans-serif" font-size="16" fill="#ff8a65" text-anchor="middle">High-Priority Pipeline (10ms)</text>
                    <ellipse cx="390" cy="120" rx="70" ry="18" fill="#ffccbc"/><text x="390" y="125" font-family="sans-serif" font-size="12" fill="#111" text-anchor="middle">high_freq_queue</text>
                    <path d="M 270 215 Q 270 130 320 125" stroke="#ff8a65" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <rect x="500" y="100" width="150" height="50" fill="#3c3c3c" rx="5"/><text x="575" y="122" font-family="sans-serif" font-size="14" fill="#ccc" text-anchor="middle">Worker Pool A</text><text x="575" y="140" font-family="sans-serif" font-size="10" fill="#aaa" text-anchor="middle">(N Processes)</text>
                    <line x1="460" y1="120" x2="500" y2="120" stroke="#ff8a65" stroke-width="2" marker-end="url(#arrow)"/>

                    <!-- Low Freq Pipeline -->
                    <text x="550" y="310" font-family="sans-serif" font-size="16" fill="#90caf9" text-anchor="middle">Low-Priority Pipeline (100ms)</text>
                    <ellipse cx="390" cy="360" rx="70" ry="18" fill="#e3f2fd"/><text x="390" y="365" font-family="sans-serif" font-size="12" fill="#111" text-anchor="middle">low_freq_queue</text>
                    <path d="M 270 265 Q 270 350 320 355" stroke="#90caf9" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <rect x="500" y="340" width="150" height="50" fill="#3c3c3c" rx="5"/><text x="575" y="362" font-family="sans-serif" font-size="14" fill="#ccc" text-anchor="middle">Worker Pool B</text><text x="575" y="380" font-family="sans-serif" font-size="10" fill="#aaa" text-anchor="middle">(M Processes)</text>
                    <line x1="460" y1="360" x2="500" y2="360" stroke="#90caf9" stroke-width="2" marker-end="url(#arrow)"/>

                    <!-- Final Outputs -->
                    <ellipse cx="700" cy="240" rx="50" ry="15" fill="#81d4fa"/><text x="700" y="245" font-family="sans-serif" font-size="12" fill="#111" text-anchor="middle">log_queue</text>
                    <path d="M 650 120 Q 680 180 680 225" stroke="#ff8a65" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <path d="M 650 360 Q 680 300 680 255" stroke="#90caf9" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
                    <text x="700" y="450" font-family="sans-serif" font-size="14" fill="#ccc" text-anchor="middle">LogWriter -> can_log.json</text>
                    <line x1="700" y1="255" x2="700" y2="420" stroke="#4fc3f7" stroke-width="2" marker-end="url(#arrow)"/>
                    
                    <text x="575" y="180" font-family="sans-serif" font-size="12" fill="#ccc" text-anchor="middle">-> Shared Dictionary</text>
                    <text x="575" y="420" font-family="sans-serif" font-size="12" fill="#ccc" text-anchor="middle">-> Shared Dictionary</text>
                </svg>
            </div>
            <p>This "Dual Pipeline" architecture is the core of the CAN logger. It addresses the need to process high-frequency (10ms) and low-frequency (100ms) signals without interference.</p>
            <ul>
                <li><strong>CANReader Thread:</strong> A single, fast thread is dedicated to reading all messages from the CAN bus. It acts as a dispatcher, performing a quick check on the message ID to sort it into one of two queues.</li>
                <li><strong>High-Priority Pipeline:</strong> A dedicated <code>multiprocessing.Queue</code> and a pool of worker processes handle only the high-frequency signals.</li>
                <li><strong>Low-Priority Pipeline:</strong> A second, parallel queue and worker pool handle the low-frequency signals.</li>
                <li><strong>Benefits:</strong> This design ensures that a sudden burst of low-priority messages (e.g., status updates) can never delay the processing of critical, high-frequency data (e.g., torque, speed). It leverages multiple CPU cores for true parallel decoding, bypassing Python's Global Interpreter Lock (GIL).</li>
            </ul>
        </div>

        <div class="card">
            <h2>2. Key Bug Fixes and Solutions</h2>
            
            <h3>Startup Race Condition</h3>
            <ul>
                <li><strong>Problem:</strong> The radar tracker process would start and request CAN data before the CAN logger process had finished initializing and decoding its first messages. This resulted in the tracker processing uninitialized or "garbage" data for the first ~10 frames.</li>
                <li><strong>Solution:</strong> A synchronization system using <code>multiprocessing.Event</code> was implemented. The CAN logger's worker processes now only set the "ready" event after they have successfully decoded and shared a predefined set of <strong>critical signals</strong> (e.g., speed, torque, accelerator pedal). The radar tracker process waits for this event before starting its main loop, guaranteeing it has a complete set of valid data from the very first frame.</li>
            </ul>

            <h3>Cross-Platform Stability (Windows)</h3>
            <ul>
                <li><strong>Problem:</strong> The application would crash on Windows with <code>QObject</code> timer errors or <code>PermissionError</code> when starting child processes.</li>
                <li><strong>Solution:</strong> These issues were traced to how `multiprocessing` and thread-sensitive libraries (like Qt, used by the PCAN driver) interact. The architecture was refined to ensure that hardware-related objects (like the <code>can.Bus</code>) are created, used, and destroyed entirely within the same dedicated thread, respecting library constraints. Furthermore, all critical module imports were moved inside the <code>if __name__ == '__main__':</code> block to prevent unsafe resource inheritance by child processes on Windows.</li>
            </ul>

            <h3>Data Corruption in Logs and Shared Data</h3>
            <ul>
                <li><strong>Problem:</strong> Numeric values in the final <code>can_log.json</code> and <code>track_history.json</code> files, as well as in the live shared data, would appear as massive, incorrect numbers.</li>
                <li><strong>Solution:</strong> The root cause was the use of non-standard numeric types (like <code>numpy.float64</code>) in data structures that were passed between processes or serialized to JSON. The entire data pipeline was audited and fixed to explicitly cast all numeric data to a standard Python <code>float()</code> at every stage: before being placed in the shared dictionary, after interpolation, and before being written to a file. This ensures data integrity across the entire system.</li>
            </ul>
        </div>

        <div class="card">
            <h2>3. Future Considerations & Improvements</h2>
            <p>While the current system is robust, the following methods could be implemented to further improve performance and reliability.</p>
            <div class="improvement-grid">
                <div class="improvement-card">
                    <svg viewBox="0 0 24 24"><path fill="#4fc3f7" d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
                    <h3>Profile for Bottlenecks</h3>
                    <p>Use tools like <code>cProfile</code> to get a detailed breakdown of where the application is spending the most time. This provides concrete data to guide optimization efforts.</p>
                </div>
                <div class="improvement-card">
                    <svg viewBox="0 0 24 24"><path fill="#ffb74d" d="M11,15H13V17H11V15M11,7H13V13H11V7M12,2C6.47,2 2,6.47 2,12C2,17.53 6.47,22 12,22C17.53,22 22,17.53 22,12C22,6.47 17.53,2 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20Z" /></svg>
                    <h3>Monitor Queue Health</h3>
                    <p>Add a monitoring thread to periodically check queue sizes. If a queue is consistently full, it's a clear sign of a bottleneck, providing an immediate diagnosis.</p>
                </div>
                <div class="improvement-card">
                    <svg viewBox="0 0 24 24"><path fill="#81c784" d="M12,2A2,2 0 0,0 10,4V8A2,2 0 0,0 12,10A2,2 0 0,0 14,8V4A2,2 0 0,0 12,2M17,12A1,1 0 0,0 16,11H8A1,1 0 0,0 7,12A1,1 0 0,0 8,13H16A1,1 0 0,0 17,12M12,14A2,2 0 0,0 10,16V20A2,2 0 0,0 12,22A2,2 0 0,0 14,20V16A2,2 0 0,0 12,14M4,10A2,2 0 0,0 2,12A2,2 0 0,0 4,14H8A2,2 0 0,0 10,12A2,2 0 0,0 8,10H4M16,14A2,2 0 0,0 14,12A2,2 0 0,0 16,10H20A2,2 0 0,0 22,12A2,2 0 0,0 20,14H16Z" /></svg>
                    <h3>CPU Core Pinning</h3>
                    <p>On Linux, assign processes to specific CPU cores. This reduces context-switching and improves cache efficiency, leading to more consistent real-time performance.</p>
                </div>
            </div>
        </div>

    </div>
</body>
</html>